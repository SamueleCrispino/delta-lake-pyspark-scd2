:: loading settings :: url = jar:file:/opt/spark-3.5.0-bin-hadoop3/jars/ivy-2.5.1.jar!/org/apache/ivy/core/settings/ivysettings.xml
pyspark version:  3.5.0
Spark Version:  3.5.0
READ_PATH:  /data/crm_with_event_time/header/header_20230127.csv
WRITE_PATH:  /data/delta/landing/header/
AFTER TRANSFORM PHASE:
+-------------+-----------------+--------------+-----------+----------+----------+--------------------+-----------------+-------------+-------------------------+-------------+---------------+-------------------+-------------------------+----------------------------------+-------------------+-------------------+----------+---------------+----------------+--------------+-----------------+--------------------+
|contratto_cod|codice_ordine_sap|tipo_contratto|codice_opec|data_firma|net_amount|causale_annullamento|data_annullamento|codice_agente|status_quote             |creazione_dta|closed_by_batch|source_file        |ingest_ts                |batch_id                          |valid_from_ts      |valid_to_ts        |is_current|valid_from_year|valid_from_month|valid_from_day|creazione_dta_raw|creazione_dta_parsed|
+-------------+-----------------+--------------+-----------+----------+----------+--------------------+-----------------+-------------+-------------------------+-------------+---------------+-------------------+-------------------------+----------------------------------+-------------------+-------------------+----------+---------------+----------------+--------------+-----------------+--------------------+
|C00000162    |3000000162       |365,366,400   |OPEC0162   |2022-08-26|20796.63  |NULL                |NULL             |10162        |Accepted,Rejected,Pending|2022-08-09   |NULL           |header_20230127.csv|2025-09-04 20:48:20.69761|20250904204820_header_20230127.csv|2023-01-27 05:04:16|9999-12-31 00:00:00|true      |2023           |1               |27            |2022-08-09       |2022-08-09          |
|C00000227    |3000000227       |NULL          |OPEC0227   |2022-12-10|39669.06  |NULL                |NULL             |10227        |NULL                     |2022-11-28   |NULL           |header_20230127.csv|2025-09-04 20:48:20.69761|20250904204820_header_20230127.csv|2023-01-27 18:42:02|9999-12-31 00:00:00|true      |2023           |1               |27            |2022-11-28       |2022-11-28          |
|C00000254    |3000000254       |NULL          |OPEC0254   |2022-12-12|37507.69  |NULL                |NULL             |10254        |NULL                     |2022-11-26   |NULL           |header_20230127.csv|2025-09-04 20:48:20.69761|20250904204820_header_20230127.csv|2023-01-27 11:17:10|9999-12-31 00:00:00|true      |2023           |1               |27            |2022-11-26       |2022-11-26          |
|C00000430    |3000000430       |NULL          |OPEC0430   |2023-01-25|38565.74  |NULL                |NULL             |10430        |NULL                     |2023-01-17   |NULL           |header_20230127.csv|2025-09-04 20:48:20.69761|20250904204820_header_20230127.csv|2023-01-27 00:51:27|9999-12-31 00:00:00|true      |2023           |1               |27            |2023-01-17       |2023-01-17          |
|C00000490    |3000000490       |NULL          |OPEC0490   |2022-02-20|30280.46  |NULL                |NULL             |10490        |NULL                     |2022-01-22   |NULL           |header_20230127.csv|2025-09-04 20:48:20.69761|20250904204820_header_20230127.csv|2023-01-27 02:35:56|9999-12-31 00:00:00|true      |2023           |1               |27            |2022-01-22       |2022-01-22          |
|C00000532    |3000000532       |NULL          |OPEC0532   |2022-07-27|45385.38  |NULL                |NULL             |10032        |NULL                     |2022-07-24   |NULL           |header_20230127.csv|2025-09-04 20:48:20.69761|20250904204820_header_20230127.csv|2023-01-27 22:22:44|9999-12-31 00:00:00|true      |2023           |1               |27            |2022-07-24       |2022-07-24          |
|C00000549    |3000000549       |365,366,400   |OPEC0549   |2022-01-30|33053.76  |NULL                |NULL             |10049        |Accepted,Rejected,Pending|2022-01-13   |NULL           |header_20230127.csv|2025-09-04 20:48:20.69761|20250904204820_header_20230127.csv|2023-01-27 06:37:37|9999-12-31 00:00:00|true      |2023           |1               |27            |2022-01-13       |2022-01-13          |
|C00000639    |3000000639       |365,366,400   |OPEC0639   |2022-07-14|2950.28   |NULL                |NULL             |10139        |Accepted,Rejected,Pending|2022-06-29   |NULL           |header_20230127.csv|2025-09-04 20:48:20.69761|20250904204820_header_20230127.csv|2023-01-27 19:37:29|9999-12-31 00:00:00|true      |2023           |1               |27            |2022-06-29       |2022-06-29          |
|C00000687    |3000000687       |365,366,400   |OPEC0687   |2022-02-11|28667.8   |NULL                |NULL             |10187        |Accepted,Rejected,Pending|2022-01-29   |NULL           |header_20230127.csv|2025-09-04 20:48:20.69761|20250904204820_header_20230127.csv|2023-01-27 16:37:16|9999-12-31 00:00:00|true      |2023           |1               |27            |2022-01-29       |2022-01-29          |
|C00000707    |3000000707       |NULL          |OPEC0707   |2022-03-12|35165.12  |NULL                |NULL             |10207        |NULL                     |2022-03-10   |NULL           |header_20230127.csv|2025-09-04 20:48:20.69761|20250904204820_header_20230127.csv|2023-01-27 12:39:13|9999-12-31 00:00:00|true      |2023           |1               |27            |2022-03-10       |2022-03-10          |
|C00000770    |3000000770       |NULL          |OPEC0770   |2022-06-18|3568.58   |NULL                |NULL             |10270        |NULL                     |2022-06-14   |NULL           |header_20230127.csv|2025-09-04 20:48:20.69761|20250904204820_header_20230127.csv|2023-01-27 18:21:54|9999-12-31 00:00:00|true      |2023           |1               |27            |2022-06-14       |2022-06-14          |
|C00000772    |3000000772       |NULL          |OPEC0772   |2022-08-10|731.63    |NULL                |NULL             |10272        |NULL                     |2022-07-12   |NULL           |header_20230127.csv|2025-09-04 20:48:20.69761|20250904204820_header_20230127.csv|2023-01-27 05:04:23|9999-12-31 00:00:00|true      |2023           |1               |27            |2022-07-12       |2022-07-12          |
|C00000806    |3000000806       |NULL          |OPEC0806   |2022-03-18|17621.8   |NULL                |NULL             |10306        |NULL                     |2022-03-16   |NULL           |header_20230127.csv|2025-09-04 20:48:20.69761|20250904204820_header_20230127.csv|2023-01-27 17:27:59|9999-12-31 00:00:00|true      |2023           |1               |27            |2022-03-16       |2022-03-16          |
|C00001100    |3000001100       |NULL          |OPEC0100   |2022-05-14|33661.89  |NULL                |NULL             |10100        |NULL                     |2022-05-03   |NULL           |header_20230127.csv|2025-09-04 20:48:20.69761|20250904204820_header_20230127.csv|2023-01-27 20:04:16|9999-12-31 00:00:00|true      |2023           |1               |27            |2022-05-03       |2022-05-03          |
|C00001121    |3000001121       |NULL          |OPEC0121   |2022-03-19|12572.52  |NULL                |NULL             |10121        |NULL                     |2022-02-20   |NULL           |header_20230127.csv|2025-09-04 20:48:20.69761|20250904204820_header_20230127.csv|2023-01-27 09:55:12|9999-12-31 00:00:00|true      |2023           |1               |27            |2022-02-20       |2022-02-20          |
|C00001158    |3000001158       |365,366,400   |OPEC0158   |2022-06-23|46451.88  |NULL                |NULL             |10158        |Accepted,Rejected,Pending|2022-05-28   |NULL           |header_20230127.csv|2025-09-04 20:48:20.69761|20250904204820_header_20230127.csv|2023-01-27 20:25:49|9999-12-31 00:00:00|true      |2023           |1               |27            |2022-05-28       |2022-05-28          |
|C00001414    |3000001414       |NULL          |OPEC0414   |2022-10-19|32451.66  |NULL                |NULL             |10414        |NULL                     |2022-10-07   |NULL           |header_20230127.csv|2025-09-04 20:48:20.69761|20250904204820_header_20230127.csv|2023-01-27 22:07:49|9999-12-31 00:00:00|true      |2023           |1               |27            |2022-10-07       |2022-10-07          |
|C00001475    |3000001475       |NULL          |OPEC0475   |2022-10-24|35007.44  |NULL                |NULL             |10475        |NULL                     |2022-10-01   |NULL           |header_20230127.csv|2025-09-04 20:48:20.69761|20250904204820_header_20230127.csv|2023-01-27 02:17:08|9999-12-31 00:00:00|true      |2023           |1               |27            |2022-10-01       |2022-10-01          |
|C00001484    |3000001484       |NULL          |OPEC0484   |2022-06-18|42891.31  |NULL                |NULL             |10484        |NULL                     |2022-06-11   |NULL           |header_20230127.csv|2025-09-04 20:48:20.69761|20250904204820_header_20230127.csv|2023-01-27 04:11:55|9999-12-31 00:00:00|true      |2023           |1               |27            |2022-06-11       |2022-06-11          |
|C00001541    |3000001541       |NULL          |OPEC0541   |2022-02-27|38612.44  |NULL                |NULL             |10041        |NULL                     |2022-02-03   |NULL           |header_20230127.csv|2025-09-04 20:48:20.69761|20250904204820_header_20230127.csv|2023-01-27 10:10:28|9999-12-31 00:00:00|true      |2023           |1               |27            |2022-02-03       |2022-02-03          |
+-------------+-----------------+--------------+-----------+----------+----------+--------------------+-----------------+-------------+-------------------------+-------------+---------------+-------------------+-------------------------+----------------------------------+-------------------+-------------------+----------+---------------+----------------+--------------+-----------------+--------------------+
only showing top 20 rows

INIT DELTA TABLE
ERROR:root:Exception while sending command.
Traceback (most recent call last):
  File "/opt/spark/python/lib/py4j-0.10.9.7-src.zip/py4j/clientserver.py", line 511, in send_command
    answer = smart_decode(self.stream.readline()[:-1])
RuntimeError: reentrant call inside <_io.BufferedReader name=3>

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/opt/spark/python/lib/py4j-0.10.9.7-src.zip/py4j/java_gateway.py", line 1038, in send_command
    response = connection.send_command(command)
  File "/opt/spark/python/lib/py4j-0.10.9.7-src.zip/py4j/clientserver.py", line 539, in send_command
    raise Py4JNetworkError(
py4j.protocol.Py4JNetworkError: Error while sending or receiving
ERROR:root:Exception while sending command.
Traceback (most recent call last):
  File "/opt/spark/python/lib/py4j-0.10.9.7-src.zip/py4j/clientserver.py", line 511, in send_command
    answer = smart_decode(self.stream.readline()[:-1])
  File "/usr/lib/python3.10/socket.py", line 705, in readinto
    return self._sock.recv_into(b)
  File "/opt/spark/python/lib/pyspark.zip/pyspark/context.py", line 381, in signal_handler
    self.cancelAllJobs()
  File "/opt/spark/python/lib/pyspark.zip/pyspark/context.py", line 2446, in cancelAllJobs
    self._jsc.sc().cancelAllJobs()
  File "/opt/spark/python/lib/py4j-0.10.9.7-src.zip/py4j/java_gateway.py", line 1322, in __call__
    return_value = get_return_value(
  File "/opt/spark/python/lib/pyspark.zip/pyspark/errors/exceptions/captured.py", line 179, in deco
    return f(*a, **kw)
  File "/opt/spark/python/lib/py4j-0.10.9.7-src.zip/py4j/protocol.py", line 334, in get_return_value
    raise Py4JError(
py4j.protocol.Py4JError: An error occurred while calling o22.sc

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/opt/spark/python/lib/py4j-0.10.9.7-src.zip/py4j/java_gateway.py", line 1038, in send_command
    response = connection.send_command(command)
  File "/opt/spark/python/lib/py4j-0.10.9.7-src.zip/py4j/clientserver.py", line 539, in send_command
    raise Py4JNetworkError(
py4j.protocol.Py4JNetworkError: Error while sending or receiving
Traceback (most recent call last):
  File "/data/delta-lake-pyspark-scd2/header_etl.py", line 371, in <module>
    run_job_header(spark, read_path, write_path, discarded_path, metrics_path)
  File "/data/delta-lake-pyspark-scd2/header_etl.py", line 160, in run_job_header
    df_transformed.write.partitionBy(partition_columns).format("delta").save(write_path)
  File "/opt/spark/python/lib/pyspark.zip/pyspark/sql/readwriter.py", line 1463, in save
  File "/opt/spark/python/lib/py4j-0.10.9.7-src.zip/py4j/java_gateway.py", line 1322, in __call__
  File "/opt/spark/python/lib/pyspark.zip/pyspark/errors/exceptions/captured.py", line 179, in deco
  File "/opt/spark/python/lib/py4j-0.10.9.7-src.zip/py4j/protocol.py", line 334, in get_return_value
py4j.protocol.Py4JError: An error occurred while calling o278.save
